{% extends "base.html" %}
{% block body %}
    <div class="container pt-3">
		<h4>Review Question</h4>
		<div class="container">
			<h5>Preview:</h5>
			<span class="container py-2">
				The question will appear to students as shown below.
			</span>

			<div class="container">
			<iframe
				id="preview-frame"
				title="Question Preview"
				src="{{ url_for('instructor.preview_question', question_id=question.id) }}"
				width="100%"
				onload="removeNavbar(this)"></iframe>
			</div>
		</div>

		<div class="container mt-2">
			<h5>Answer:</h5>
			<div class="container">
			{{ question.get_answer()|safe }}
			</div>
		</div>

        <div class="container" id="learningObjective">
            
            <h5>Learning Objective:</h5>
            <div class="container pb-2">
                <div v-if="objective_text === ''">
                    <em>None.</em>
                    <div class="pt-2">
                        <i class="bi-plus-square"></i>
                        <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#setObjectiveModal">
                            Add Objective
                        </a>
                    </div>
                </div>
                <div v-else>
                    <span v-html="objective_text"></span>
                    <div>
                        <i class="bi-pencil-square"></i>
                        <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#setObjectiveModal">
                            Change Objective
                        </a>
                        <br/>
                        <i class="bi-trash"></i>
                        <a href="#" 
                           class="text-decoration-none text-danger"
                           @click="removeObjective()"
                           >
                            Remove Objective
                        </a>
                    </div>
                </div>
            </div>

            <set-objective-modal 
               name="setObjectiveModal"
                  @objective-set="setObjective"
                  @created-new-objective="displayMessage('Successfully created a new objective.')"
                  @failed-to-create="displayMessage('Failed to create objective.')"
                  @failed-to-search="displayMessage('Failed to obtain search results.')">
            </set-objective-modal>
        </div>

        <div class="container pt-2">
            <h5>Availability:</h5>
            <div class="container pb-2">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="publicQuestion" {% if question.public %}checked{% endif %}
                           onchange="patchBooleanField(this, 'public', {{question.id}})">
                    <label class="form-check-label" for="publicQuestion">Public</label>
                </div>


                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enabledQuestion" {% if question.enabled %}checked{% endif %}
                           onchange="patchBooleanField(this, 'enabled', {{question.id}})">
                    <label class="form-check-label" for="enabledQuestion">Enabled</label>
                </div>

                <span class="text-secondary">
                    <i class="bi-info-circle"></i>
                    Public questions are available to all users to add to
                    their own courses. Only questions that have been
                    <em>enabled</em> are available for use.
                </span>
            </div>
        </div>

    </div>

    <div id="snackbar">Default message.</div> 

    <script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
    <script src="https://unpkg.com/vue@3"></script>

    <script src="{{ url_for('static', filename='js/helpers.js') }}" type="module"></script>

    <script type="module">
		import { fetchOrRefresh, getCookie, showSnackbarMessage } from '/static/js/helpers.js';
        import * as CadetApi from '/static/js/cadet-api.js';
		import SetObjectiveModal from '/static/js/objective-modal.js';

        const converter = new showdown.Converter();
        const refresh_url = "{{ url_for('auth.refresh_jwts') }}";

        window.patchBooleanField = async function patchBooleanField(toggle, field_name, question_id) {
            const response = await CadetApi.updateQuestionField(field_name, toggle.checked, question_id);

			if (!response.ok) {
                toggle.checked = !toggle.checked;
				showSnackbarMessage(`Error updating question. Try again. (HTTP Status: ${response.status})`);
                return;
			}

            showSnackbarMessage("Question successfully updated.");
        }

		// Hide the navbar inside the preview
		window.removeNavbar = function removeNavbar(iframe) {
			iframe.height = iframe.contentWindow.document.body.scrollHeight;
			iframe.style.border = "thin solid #d3d3d3";
			const navbar = iframe.contentWindow.document.getElementById("navbar");
			navbar.style.display = "none";
		}

        const app = Vue.createApp({
            data() {
                return {
                    objective_text: "",
                }
            },

			components: {
				SetObjectiveModal,
			},

            methods: {
				displayMessage(msg) {
					showSnackbarMessage(msg);
				},

                async setObjective(objective_id) {
                    const response = await CadetApi.setQuestionObjective({{ question.id }}, objective_id);

                    if (response.ok) {
                        const r = await response.json()
                        this.objective_text = this.convertToHtml(r["updated"].objective.description);
                        showSnackbarMessage("Successfully updated learning objective.");
                    }
                    else {
                        showSnackbarMessage(`Error updating learning objective. Try again. (HTTP Status: ${response.status})`);
                    }
                },

                async removeObjective() {
                    const response = await CadetApi.removeQuestionObjective({{ question.id }});
                    if (response.ok) {
                        this.objective_text = "";
                        showSnackbarMessage("Successfully removed learning objective.");
                    }
                    else {
                        showSnackbarMessage(`Error removing learning objective. Try again. (HTTP Status: ${response.status})`);
                    }
                },

                convertToHtml(md_text) {
                    return converter.makeHtml(md_text);
                }
            },

            compilerOptions: {
                delimiters: ["[[", "]]"]
            },
        });
        
        const vm = app.mount('#learningObjective');
        {% if question.objective %}
            vm.objective_text = converter.makeHtml("{{ question.objective.description|trim }}");
        {% endif %}
	</script>
{% endblock %}
