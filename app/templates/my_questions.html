{% extends "base.html" %}
{% block body %}
    <div class="container pt-3">
        <h4>My Questions</h4>

		<div class="row" id="currentQuestions">
			<confirmation-dialog name="confirmationModal"
				 @confirmed="resolveConfirmation(true)"
				 @cancelled="resolveConfirmation(false)">
				Are you sure you want to delete these questions.
				<strong>This action cannot be undone.</strong>
			</confirmation-dialog>

			<div class="container" v-if="selected_indices.length > 0">
				<span class="mx-2">
					<strong>Selected ([[ selected_indices.length ]])</strong>
				</span>

				<button type="button" class="btn btn-sm btn-secondary">
					<i class="bi-tag"></i>
					Learning Objective
				</button>

				<div class="btn-group mx-2">
					<button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
						<i class="bi-tools"></i>
						Settings
					</button>
					<ul class="dropdown-menu">
						<li><button class="dropdown-item" type="button"
										@click="updateQuestions('public', true)">
								<i class="bi-people"></i>
								Mark as Public</button></li>
						<li><button class="dropdown-item" type="button"
										@click="updateQuestions('public', false)">
								<i class="bi-person"></i>
								Mark as Private</button></li>
						<li><hr class="dropdown-divider"></li>
						<li><button class="dropdown-item" type="button"
										@click="updateQuestions('enabled', true)">
								<i class="bi-eye"></i>
								Mark as Enabled</button></li>
						<li><button class="dropdown-item" type="button"
										@click="updateQuestions('enabled', false)">
								<i class="bi-eye-slash"></i>
								Mark as Disabled</button></li>
					</ul>
				</div>

				<button type="button" class="btn btn-sm btn-danger" @click="deleteSelected">
					<i class="bi-trash"></i>
					Delete
				</button>
			</div>

			<ul class="list-unstyled" v-if="questions.length > 0">
				<li class="m-2"
					v-for="(q, index) in questions" :key="q.id">
						<div class="container row">
							<div class="col-auto pt-2 border"
								:class="{'bg-light': !selected_indices.includes(index), 'bg-primary bg-gradient': selected_indices.includes(index)}">
								<input 
										:id="`q${index}`" :value=index v-model.number="selected_indices"
										name="aQuestion" type="checkbox">
								<label :for="`q${index}`" class="visually-hidden">Question with ID [[q.id]]</label>
							</div>
							<div class="col-10 p-1 border-top border-bottom">

								<table class="table table-borderless table-sm">
									<tbody>
										<tr>
											<th scope="row" class="col-1">Type:</th>
											<td>[[ typeStrings[index] ]]</td>
										</tr>
										<tr>
											<th scope="row">Prompt:</th>
											<td>
												<div class="clippy" v-html="convertToHtml(q.prompt)"></div>
											</td>
										</tr>
										<tr>
											<th scope="row">Learning Objective:</th>
											<td>
												[[ q.objective ? q.objective["description"] : "None" ]]
											</td>
										</tr>
										<tr>
											<th scope="row">Public:</th>
											<td>
												<span class="text-success" v-if="q.public">
													<i class="bi-check-circle"></i>
												</span>
												<span class="text-danger" v-else>
													<i class="bi-x-circle"></i>
												</span>
											</td>
										</tr>
										<tr>
											<th scope="row">Enabled:</th>
											<td>
												<span class="text-success" v-if="q.enabled">
													<i class="bi-check-circle"></i>
												</span>
												<span class="text-danger" v-else>
													<i class="bi-x-circle"></i>
												</span>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div class="col-auto pt-2 border border-start-0">
								<i class="bi-pencil-square"></i>
								<a class="text-decoration-none text-secondary" :href="'/q/' +  q.id  + '/edit'">
									Edit
								</a>
								<br/>
								<i class="bi-eye"></i>
								<a class="text-decoration-none text-secondary" :href="'/q/' +  q.id  + '/preview'">
									Preview
								</a>
							</div>
						</div>
				</li>
			</ul>
		</div>

		<div class="row">
			<span class="dropdown">
				<button class="btn btn-link dropdown-toggle text-decoration-none" type="button" id="newQuestionButton" data-bs-toggle="dropdown" aria-expanded="false">
					Create New Question
				</button>
				<ul class="dropdown-menu" aria-labelledby="newQuestionButton">
					<li><a class="dropdown-item" href="{{url_for('instructor.create_new_question', question_type='short-answer')}}">Short Answer (Self-Graded)</a></li>
					<li><a class="dropdown-item" href="{{url_for('instructor.create_new_question', question_type='auto-check')}}">Short Answer (Auto-Graded)</a></li>
					<li><a class="dropdown-item" href="{{url_for('instructor.create_new_question', question_type='multiple-choice')}}">Multiple Choice</a></li>
					<li><a class="dropdown-item" href="{{url_for('instructor.create_new_question', question_type='code-jumble')}}">Code Jumble</a></li>
				</ul>
			</span>
		</div>

	</div>

	<div id="snackbar">Default message.</div> 

	<script src="{{ url_for('static', filename='js/helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/confirmation-dialog.js') }}"></script>

    <script src="https://unpkg.com/vue@3"></script>

	<script type="text/javascript">
        const converter = new showdown.Converter();
        const refresh_url = "{{ url_for('auth.refresh_jwts') }}";

        app = Vue.createApp({
            data() {
                return {
                    questions: [],
					target_user: {{ target_author }},
					selected_indices: [],
					resolveConfirmation: undefined,
                }
            },

			components: {
				ConfirmationDialog
			},

			computed: {
				typeStrings() {
					return this.questions.map(this.getTypeString);
				},
			},

            methods: {
                async deleteQuestion(index) {
					const url = `/api/question/${this.questions[index].id}`;
                    const response = await fetchOrRefresh(url, 'DELETE');
                    if (response.ok) {
						this.questions.splice(index, 1);

						// TODO: save the question that was deleted and offer
						// "undo" option

                        showSnackbarMessage("Successfully deleted question.");
                    }
                    else {
                        showSnackbarMessage(`Error deleting question. Try again. (HTTP Status: ${response.status})`);
                    }
                },

                async updateQuestions(field_name, field_value) {
					for (let i = 0; i <  this.selected_indices.length; i++) {
						const index = this.selected_indices[i];
						const q_id = this.questions[index].id;
						const response = await this.updateQuestion(field_name, field_value, q_id);

						if (response.ok) {
							showSnackbarMessage("Successfully updated question.");
							this.questions[index][field_name] = field_value;
						}
						else {
							showSnackbarMessage(`Error updating question. Try again. (HTTP Status: ${response.status})`);
						}
					}
                },

				async updateQuestion(field_name, field_value, question_id) {
					const config = {
						method: 'PATCH',
						credentials: 'same-origin',
						headers: {
							"Content-Type": "application/json",
							'X-CSRF-TOKEN': getCookie('csrf_access_token'),
						},
						body: JSON.stringify({[field_name]: field_value})
					}

					const url = `/api/question/${question_id}`;
					const response = await fetchOrRefresh(url, 'PATCH', refresh_url, config);

					return response;
				},

				getConfirmation() {
					const modal_el = document.getElementById('confirmationModal');
					const confirmation_modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
					confirmation_modal.show();

					return new Promise((resolve, reject) => {
						this.resolveConfirmation = resolve
					});
				},

				async deleteSelected() {
					// get confirmation first
					const confirmation = await this.getConfirmation();

					// if resolved to true, then we can delete
					if (confirmation) {
						for (let i = 0; i <  this.selected_indices.length; i++) {
							const index = this.selected_indices[i];
							await this.deleteQuestion(index);
						}
					}
				},

                async getQuestions() {
                    let url = "{{ url_for('questions_api') }}";
					url = url + `?author=${this.target_user}`;

                    const response = await fetchOrRefresh(url, 'GET', refresh_url);
                    if (response.ok) {
                        const r = await response.json();
                        this.questions = r["questions"];
                    }
                    else {
                        showSnackbarMessage(`Error loading questions. Try again. (HTTP Status: ${response.status})`);
                    }
                },

                convertToHtml(md_text) {
                    return converter.makeHtml(md_text);
				},

				getTypeString(q) {
					switch (q.type) {
						case 'short-answer':
							return "Short Answer (Self-Graded)";
						case 'auto-check':
							return "Short Answer (Auto-Graded)";
						case 'multiple-choice':
							return "Multiple Choice";
						case 'code-jumble':
							return "Code Jumble";
						default:
							return q.type;
					}
				},
            },

            created() {
                this.getQuestions();
            },

            compilerOptions: {
                delimiters: ["[[", "]]"]
            },
        });
        
        const vm = app.mount('#currentQuestions');
	</script>
{% endblock %}
