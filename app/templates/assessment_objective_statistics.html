{% extends "base.html" %}
{% import 'forms.html' as forms %}

{% macro objective_list_group(objectives) %}
	<ul class="list-group">
		{% for objective in objectives %}
			<li class="list-group-item d-flex justify-content-between align-items-start">
				<div>
					<div class="fw-bold fs-5">{{ objective.description }}</div>
	
                    {% set e_factor_average = 0 %}
                    {% set interval_average = 0 %}
                    {% set count = 0 %}
                    {% set every_day = 1 %}
                    {% set every_other_day = 1 %}
                    {% set every_3_days = 1 %}
                    {% set every_4_days = 1 %}
                    {% set every_5_days_or_more = 1 %}

                    {% for user in course.users %}
                        {% set e_factor_average = e_factor_average + objective.get_e_factor_average(user, assessment) %}
                        {% set interval_average = interval_average + objective.get_interval_average(user, assessment) %}
                        {% if interval_average == 1 %}
                            {% set every_day = every_day + 1 %}
                        {% elif interval_average == 2 %}
                            {% set every_other_day = every_other_day + 1 %} 
                        {% elif interval_average == 3 %}
                            {% set every_3_days = every_3_days + 1 %} 
                        {% elif interval_average == 4 %}
                            {% set every_4_days = every_4_days + 1 %} 
                        {% else %}
                            {% set every_5_days_or_more = every_5_days_or_more + 1 %} 
                        {% endif %}

                    {% endfor %}
                    {% if course.users.count() == 0 %}
                        {% set count = 1 %}
                    {% else %}
                        {% set count = course.users.count() %}
                    {% endif%}
                    {% set rating = e_factor_average / count %}
                    {% if rating < 1.3 %}
                        {% set full = 1 %}  
                    {% elif rating < 2.4 %}
                        {% set full = 2 %} 
                    {% elif rating < 3 %}
                        {% set full = 3 %}
                    {% elif rating < 5 %}
                        {% set full = 4 %}
                    {% else %}
                        {% set full = 5 %}
                    {% endif %}
                    {% for i in range(full) %}
                        <i class="bi bi-star-fill" style="color: gold"></i>
                        {% endfor %}
                    {% for i in range(5-full) %}
                        <i class="bi bi-star" style="color: gold"></i>
                        {% endfor %}

					</div>
	
                <div class="fw-bold fs-5">Students' Average Repeat Interval<div id="{{objective.description}}"></div></div>
                

                <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
                <script>
                    var data = [{
                        type: "pie",
                        values: [{{every_day}}, {{every_other_day}}, {{every_3_days}}, {{every_4_days}}, {{every_5_days_or_more}}],
                        labels: ["Everyday", "Every Other Day", "Every 3 Days", "Every 4 Days", "Every 5 Days or More"],
                        marker: {
                            colors: ["#FF3333","#FFA500","#FFFF66","rgb(166,217,106)","rgb(26,150,65)"]
                        },
                        //automargin: true,
                        hole: 0.6,
                        textinfo: 'none'
                    }]
                    
                    var layout = {
                        height: 250,
                        width: 450,
                        margin: {"t": 0, "b": 0, "l": 0, "r": 0},
                        showlegend: true,
                        legend: {
                            x: 1,
                            y: 0.5}
                                    
                        }
                    
                    Plotly.newPlot('{{objective.description}}', data, layout)
                </script>
                <div>
				<a role="button" class=" btn btn-sm btn-primary position-relative"
					href="{{ url_for('user_views.test', course_name=course.name, mission_id=assessment.id) }}">
					Most Missed Questions: not linked yet
				</a>
                <br>
                <a role="button" class="mt-auto btn btn-sm btn-primary position-relative"
                    href="{{ url_for('user_views.test', course_name=course.name, mission_id=assessment.id) }}">
                    See Overall Objective Statistics: not linked yet
                </a>
			</li>
		{% endfor %}
	</ul>
{% endmacro %}

{% block body %}
    <div class="container pt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('user_views.root') }}">Home</a></li>
				<li class="breadcrumb-item"><a href="{{ url_for('user_views.course_overview',course_name=course.name) }}">{{ course.name }}</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('instructor.assessment_statistics',course_name=course.name) }}">Assessment Statistics</a></li>
                <li class="breadcrumb-item active" aria-current="page"> {{assessment.title}} Objective Statistics</li>
            </ol>
        </nav>

		<h5>Learning Objectives in {{assessment.title}}</h5>
		{{ objective_list_group(assessment.objectives) }}

    </div>
{% endblock %}
